<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Accident Alert System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10B981;
            --primary-dark: #059669;
            --danger: #EF4444;
            --danger-dark: #DC2626;
            --warning: #F59E0B;
            --background: #F3F4F6;
            --card-bg: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 24px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-lg);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Status Card */
        .status-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .status-indicator {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            transition: all 0.3s ease;
        }

        .status-indicator.idle {
            background: linear-gradient(135deg, #E5E7EB 0%, #D1D5DB 100%);
        }

        .status-indicator.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            animation: pulse 2s infinite;
        }

        .status-indicator.danger {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
            animation: shake 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .status-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .status-subtext {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Action Buttons */
        .actions {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .actions .btn {
            flex: 1;
        }

        /* Map Container */
        .map-container {
            background: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .map-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .map-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .map-placeholder {
            height: 300px;
            background: linear-gradient(135deg, #E5E7EB 0%, #D1D5DB 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: var(--text-secondary);
        }

        #map {
            height: 300px;
            width: 100%;
        }

        /* Contacts Section */
        .contacts-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .add-contact-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .add-contact-btn:hover {
            transform: scale(1.1);
        }

        .contact-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .contact-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--background);
            border-radius: 12px;
        }

        .contact-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 600;
            font-size: 14px;
        }

        .contact-phone {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .delete-contact {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: var(--danger);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .delete-contact:hover {
            background: var(--danger);
            color: white;
        }

        .no-contacts {
            text-align: center;
            padding: 24px;
            color: var(--text-secondary);
        }

        .no-contacts svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 32px;
            max-width: 360px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            transition: all 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 20px;
            animation: shake 0.5s infinite;
        }

        .modal h2 {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--danger);
        }

        .modal p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .countdown {
            font-size: 64px;
            font-weight: 700;
            color: var(--danger);
            margin: 20px 0;
        }

        /* Contact Form Modal */
        .form-group {
            margin-bottom: 16px;
            text-align: left;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-buttons .btn {
            flex: 1;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-primary);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1001;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.active {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--primary);
        }

        .toast.error {
            background: var(--danger);
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 16px;
            padding: 12px 16px;
            background: var(--background);
            border-radius: 8px;
            margin-top: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.user {
            background: var(--primary);
        }

        .legend-dot.hospital {
            background: var(--danger);
        }

        .legend-dot.police {
            background: #3B82F6;
        }

        /* WhatsApp Info */
        .whatsapp-info {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .whatsapp-info svg {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
        }

        .whatsapp-info p {
            font-size: 13px;
            opacity: 0.95;
        }

        /* Test Button */
        .test-section {
            margin-top: 20px;
        }

        .test-btn {
            background: transparent;
            border: 2px dashed var(--border);
            color: var(--text-secondary);
        }

        .test-btn:hover {
            border-color: var(--warning);
            color: var(--warning);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üö® Accident Alert</h1>
            <p>Smart Safety Companion</p>
        </div>

        <!-- WhatsApp Info -->
        <div class="whatsapp-info">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
            </svg>
            <p>Emergency alerts will be sent via WhatsApp to your saved contacts with your live location.</p>
        </div>

        <!-- Status Card -->
        <div class="status-card">
            <div class="status-indicator idle" id="statusIndicator">üõ°Ô∏è</div>
            <div class="status-text" id="statusText">Monitoring Inactive</div>
            <div class="status-subtext" id="statusSubtext">Tap the button below to start accident detection</div>
        </div>

        <!-- Action Buttons -->
        <div class="actions">
            <button class="btn btn-primary" id="startBtn" onclick="startMonitoring()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                Start Monitoring
            </button>
            <button class="btn btn-danger" id="cancelBtn" onclick="cancelAlert()" disabled>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                Cancel
            </button>
        </div>

        <!-- Test Alert Button -->
        <div class="test-section">
            <button class="btn test-btn" onclick="testAlert()">
                üß™ Test Emergency Alert (Demo)
            </button>
        </div>

        <!-- Map Container -->
        <div class="map-container">
            <div class="map-header">
                <h3>üó∫Ô∏è Nearby Emergency Services</h3>
            </div>
            <div id="map"></div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-dot user"></div>
                    <span>Your Location</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot hospital"></div>
                    <span>Hospital</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot police"></div>
                    <span>Police</span>
                </div>
            </div>
        </div>

        <!-- Contacts Section -->
        <div class="contacts-section">
            <div class="section-header">
                <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Emergency Contacts</h3>
                <button class="add-contact-btn" onclick="openContactModal()">+</button>
            </div>
            <div class="contact-list" id="contactList">
                <div class="no-contacts" id="noContacts">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <p>No emergency contacts added yet.<br>Add contacts to receive alerts.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Countdown Modal -->
    <div class="modal-overlay" id="countdownModal">
        <div class="modal">
            <div class="modal-icon">‚ö†Ô∏è</div>
            <h2>Accident Detected!</h2>
            <p>Sending emergency alert in...</p>
            <div class="countdown" id="countdown">15</div>
            <p>Tap CANCEL if you're okay</p>
            <button class="btn btn-danger" onclick="cancelAlert()">
                I'm Okay - Cancel Alert
            </button>
        </div>
    </div>

    <!-- Contact Form Modal -->
    <div class="modal-overlay" id="contactModal">
        <div class="modal">
            <h2 style="margin-bottom: 20px;">Add Emergency Contact</h2>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="contactName" placeholder="Enter contact name">
            </div>
            <div class="form-group">
                <label>WhatsApp Number</label>
                <input type="tel" id="contactPhone" placeholder="+1234567890">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeContactModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveContact()">Save Contact</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCO0kKndUNlmQi3B5mxy4dblg_8WYcuKuk&libraries=places"></script>

    <script>
        // State
        let isMonitoring = false;
        let accidentDetected = false;
        let countdownTimer = null;
        let map = null;
        let userLocation = null;
        let contacts = JSON.parse(localStorage.getItem('emergencyContacts')) || [];
        let markers = [];
        let userMarker = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderContacts();
            initMap();
        });

        // Map Initialization
        function initMap() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        userLocation = { lat, lng };

                        map = new google.maps.Map(document.getElementById('map'), {
                            zoom: 15,
                            center: userLocation
                        });

                        userMarker = new google.maps.Marker({
                            position: userLocation,
                            map: map,
                            title: 'Your Location',
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: '#10B981',
                                fillOpacity: 1,
                                strokeColor: '#059669',
                                strokeWeight: 3
                            }
                        });

                        findNearby('hospital');
                        findNearby('police');
                    },
                    () => {
                        // Default location if permission denied
                        map = new google.maps.Map(document.getElementById('map'), {
                            zoom: 12,
                            center: { lat: 40.7128, lng: -74.0060 }
                        });
                        showToast('Location access denied. Using default location.', 'error');
                    }
                );
            }
        }

        // Find Nearby Places
        function findNearby(type) {
            if (!map || !userLocation) return;

            const service = new google.maps.places.PlacesService(map);

            service.nearbySearch({
                location: userLocation,
                radius: 5000,
                type: [type]
            }, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    results.slice(0, 5).forEach(place => {
                        const marker = new google.maps.Marker({
                            position: place.geometry.location,
                            map: map,
                            title: place.name,
                            icon: {
                                url: type === 'hospital'
                                    ? 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                                    : 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                            }
                        });

                        markers.push(marker);
                    });
                }
            });
        }

        // Start Monitoring
        function startMonitoring() {
            if (contacts.length === 0) {
                showToast('Please add at least one emergency contact first!', 'error');
                openContactModal();
                return;
            }

            isMonitoring = true;
            accidentDetected = false;

            updateStatus('active', 'üõ°Ô∏è', 'Monitoring Active', 'Detecting potential accidents...');

            document.getElementById('startBtn').disabled = true;
            document.getElementById('cancelBtn').disabled = false;

            // Request sensor permissions (iOS)
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            enableSensors();
                        } else {
                            showToast('Motion sensor permission required!', 'error');
                            stopMonitoring();
                        }
                    })
                    .catch(() => {
                        showToast('Could not access sensors!', 'error');
                        stopMonitoring();
                    });
            } else {
                enableSensors();
            }

            // Also request orientation sensor
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            enableOrientation();
                        }
                    })
                    .catch(() => {});
            } else {
                enableOrientation();
            }

            showToast('Monitoring started!', 'success');
        }

        // Enable Motion Sensors
        function enableSensors() {
            window.addEventListener('devicemotion', (event) => {
                if (!isMonitoring || accidentDetected) return;

                const acc = event.accelerationIncludingGravity;
                if (!acc) return;

                const totalAcceleration = Math.sqrt(
                    acc.x * acc.x +
                    acc.y * acc.y +
                    acc.z * acc.z
                );

                // Trigger at 3.5g (configurable threshold)
                if (totalAcceleration > 30) {
                    detectAccident();
                }
            });
        }

        // Enable Orientation Sensor
        function enableOrientation() {
            window.addEventListener('deviceorientation', (event) => {
                if (!isMonitoring || accidentDetected) return;

                const beta = event.beta;   // X-axis rotation
                const gamma = event.gamma; // Y-axis rotation

                // Trigger if device is significantly tilted
                if (Math.abs(beta) > 75 || Math.abs(gamma) > 75) {
                    detectAccident();
                }
            });
        }

        // Detect Accident
        function detectAccident() {
            if (accidentDetected) return;

            accidentDetected = true;
            updateStatus('danger', 'üö®', 'Accident Detected!', 'Preparing emergency alert...');

            // Vibrate device
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }

            // Play alarm sound
            playAlarm();

            // Show countdown modal
            showCountdown();
        }

        // Play Alarm Sound
        function playAlarm() {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();

    alarmInterval = setInterval(() => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800;
        oscillator.type = 'square';

        gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);

    }, 700); // repeat beep every 0.7 sec
}

        // Show Countdown
        function showCountdown() {
            const modal = document.getElementById('countdownModal');
            modal.classList.add('active');

            let seconds = 15;
            const countdownEl = document.getElementById('countdown');
            countdownEl.textContent = seconds;

            countdownTimer = setInterval(() => {
                seconds--;
                countdownEl.textContent = seconds;

                // Vibrate on each second
                if (navigator.vibrate) {
                    navigator.vibrate(100);
                }

                if (seconds <= 0) {
                    clearInterval(countdownTimer);
                    triggerEmergency();
                }
            }, 1000);
        }

        // Cancel Alert
        function cancelAlert() {
            clearInterval(countdownTimer);
            accidentDetected = false;

            document.getElementById('countdownModal').classList.remove('active');

            if (isMonitoring) {
                updateStatus('active', 'üõ°Ô∏è', 'Monitoring Active', 'Detection resumed');
            } else {
                stopMonitoring();
            }
            clearInterval(alarmInterval);
                if (audioContext) {
                audioContext.close();
            }

            showToast('Alert cancelled', 'success');
        }

        // Trigger Emergency
        function triggerEmergency() {
            clearInterval(alarmInterval);
                if (audioContext) {
                    audioContext.close();
                }
            document.getElementById('countdownModal').classList.remove('active');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    userLocation = { lat, lng };

                    // Update map
                    if (map) {
                        map.setCenter(userLocation);

                        if (userMarker) {
                            userMarker.setPosition(userLocation);
                        }
                    }

                    // Send WhatsApp messages
                    sendEmergencyAlerts(lat, lng);

                    updateStatus('danger', 'üöë', 'Emergency Triggered!', 'Help is on the way');
                },
                (error) => {
                    showToast('Could not get location', 'error');
                    sendEmergencyAlerts(0, 0);
                }
            );
        }

        // Send Emergency Alerts via WhatsApp
        async function sendEmergencyAlerts(lat, lng) {
            const mapsLink = lat && lng
                ? `https://maps.google.com/?q=${lat},${lng}`
                : 'Location unavailable';

            const message = `üö® *EMERGENCY ALERT* üö®\n\n` +
                `An accident has been detected!\n\n` +
                `üìç *Location:* ${mapsLink}\n` +
                `üïê *Time:* ${new Date().toLocaleString()}\n\n` +
                `Please send help immediately!`;

            // Show loading
            showToast('Sending emergency alerts...', 'success');

            // Try to send via WhatsApp API (requires backend)
            try {
                // Method 1: WhatsApp Direct Link (works without backend)
                for (const contact of contacts) {
                    const phone = contact.phone.replace(/\D/g, '');
                    const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;

                    // Open WhatsApp in new tab
                    window.open(whatsappUrl, '_blank');
                }

                // Method 2: Try calling backend API (if configured)
                await sendViaBackend(lat, lng, message);

                showToast(`Alerts sent to ${contacts.length} contacts!`, 'success');
            } catch (error) {
                console.error('Error sending alerts:', error);
                showToast('Opened WhatsApp. Please send manually if needed.', 'error');
            }
        }

        // Send via Backend API
        async function sendViaBackend(lat, lng, message) {
            // Connect to backend server for WhatsApp API
            // Replace with your deployed backend URL after deployment
            const backendUrl = 'https://resqlink-xir5.onrender.com/api/send-alert';

            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contacts: contacts,
                        location: { lat, lng },
                        timestamp: new Date().toISOString(),
                        userName: 'User'
                    })
                });

                if (!response.ok) {
                    throw new Error('Backend API error');
                }

                const result = await response.json();
                console.log('Backend response:', result);
                return result;
            } catch (error) {
                console.log('Backend not configured. Using WhatsApp direct links.', error);
                throw error;
            }
        }

        // Test Alert
        function testAlert() {
            if (contacts.length === 0) {
                showToast('Please add at least one emergency contact first!', 'error');
                openContactModal();
                return;
            }

            showToast('Testing emergency alert system...', 'success');

            // Simulate accident detection
            setTimeout(() => {
                detectAccident();
            }, 1000);
        }

        // Stop Monitoring
        function stopMonitoring() {
            isMonitoring = false;
            accidentDetected = false;
            clearInterval(countdownTimer);

            updateStatus('idle', 'üõ°Ô∏è', 'Monitoring Inactive', 'Tap Start to begin detection');

            document.getElementById('startBtn').disabled = false;
            document.getElementById('cancelBtn').disabled = true;
        }

        // Update Status
        function updateStatus(state, icon, text, subtext) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const statusSubtext = document.getElementById('statusSubtext');

            indicator.className = 'status-indicator ' + state;
            indicator.textContent = icon;
            statusText.textContent = text;
            statusSubtext.textContent = subtext;
        }

        // Contact Management
        function openContactModal() {
            document.getElementById('contactModal').classList.add('active');
            document.getElementById('contactName').value = '';
            document.getElementById('contactPhone').value = '';
        }

        function closeContactModal() {
            document.getElementById('contactModal').classList.remove('active');
        }

        function saveContact() {
            const name = document.getElementById('contactName').value.trim();
            const phone = document.getElementById('contactPhone').value.trim();

            if (!name || !phone) {
                showToast('Please fill in all fields!', 'error');
                return;
            }

            // Validate phone format
            if (!phone.match(/^\+?[\d\s-]{10,}$/)) {
                showToast('Please enter a valid phone number!', 'error');
                return;
            }

            // Limit to 3 contacts
            if (contacts.length >= 3) {
                showToast('Maximum 3 contacts allowed!', 'error');
                return;
            }

            contacts.push({ name, phone });
            localStorage.setItem('emergencyContacts', JSON.stringify(contacts));

            renderContacts();
            closeContactModal();
            showToast('Contact added successfully!', 'success');
        }

        function deleteContact(index) {
            contacts.splice(index, 1);
            localStorage.setItem('emergencyContacts', JSON.stringify(contacts));
            renderContacts();
            showToast('Contact removed', 'success');
        }

        function renderContacts() {
            const list = document.getElementById('contactList');
            const noContacts = document.getElementById('noContacts');

            if (contacts.length === 0) {
                noContacts.style.display = 'block';
                return;
            }

            noContacts.style.display = 'none';

            list.innerHTML = contacts.map((contact, index) => `
                <div class="contact-card">
                    <div class="contact-avatar">${contact.name.charAt(0).toUpperCase()}</div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-phone">${contact.phone}</div>
                    </div>
                    <button class="delete-contact" onclick="deleteContact(${index})">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        // Show Toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' active';

            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }
    </script>
</body>
</html>
